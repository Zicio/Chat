(()=>{"use strict";class e{constructor(e){this.element=e}static showUsers(e){const t=document.querySelector(".chat__list");let s=null;const n=t.getElementsByClassName("user");t.childNodes.length>1&&(s=[...n].find((e=>"YOU"===e.textContent)).id);for(const s of e)if(!n.length||[...n].find((e=>e.id!==s.id))){const e=`<li class="user" id="${s.id}"><span class="user__name">${s.name}</span></li>`;t.insertAdjacentHTML("beforeend",e)}if(!s){s=t.lastChild.id;const e=document.getElementById(s);e.lastChild.dataset.myName=e.lastChild.textContent,e.lastChild.classList.add("you"),e.lastChild.textContent="YOU",e.lastChild.style.color="orange"}document.querySelector(".chat__popup").classList.remove("active"),document.querySelector(".chat__container").classList.add("active")}static showHint(e,t){const s=e.closest(".popup__form").querySelector(".form__hint");t||s.classList.remove("active"),s.classList.contains("active")||(s.textContent=t,s.classList.add("active")),s.textContent!==t&&(s.textContent=t)}static showMessages(e){const t=document.querySelector(".chat__tape");document.getElementsByClassName("chat__message");for(const s of e){const e=document.createElement("div");e.classList.add("chat__message"),t.appendChild(e);const n=document.createElement("span");n.classList.add("message__info"),n.textContent=s.name;const a=document.querySelector(".you");s.name.includes(a.dataset.myName,0)&&(e.classList.add("your-message"),n.textContent=n.textContent.replace(a.dataset.myName,"You"));const o=document.createElement("span");o.classList.add("message__text"),o.textContent=s.text,e.appendChild(n),e.appendChild(o)}}static deleteUserOffline(e){document.getElementById(e.id).remove()}}class t{constructor(){this.url=new URL("https://zicio-chat.herokuapp.com/"),this.ws=null}async checkName(e){const t=`${this.url}users/${e}`;return await fetch(t)}getWS(){const{url:e}=this,s=e.href.replace(/^https/,"wss"),n=new WebSocket(s);this.ws=n,this.ws.onopen=console.log("ONLINE"),this.ws.onmessage=e=>t.responseHandler(JSON.parse(e.data))}firstSendWS(e){this.ws.onopen=()=>this.ws.send(JSON.stringify(e))}sendWS(e){this.ws.send(JSON.stringify(e))}static responseHandler(t){if(Object.prototype.hasOwnProperty.call(t,"users"))return e.showUsers(t.users),void e.showMessages(t.messages);t.id?e.deleteUserOffline(t):t[0].id?e.showUsers(t):e.showMessages(t)}}class s{constructor(e){this.element=e,this.request=new t,this.clickListener(),this.keyListener()}clickListener(){this.element.addEventListener("click",(e=>this.clickHandler(e)))}clickHandler(e){e.target.classList.contains("form__submit")&&this.checkName(e)}async checkName(t){t.preventDefault();const n=t.target.closest(".popup__form"),a=new FormData(n).get("name"),o=n.querySelector(".form__field");if(!o.validity.valid)return void s.createHint(o);const i=await this.request.checkName(a);if(i.ok)return e.showHint(o,null),this.request.getWS(),void this.request.firstSendWS("");const c=await i.text();console.log(c),e.showHint(o,c)}static createHint(t){if(t.validity.valueMissing){const s="Напишите псевдоним!";e.showHint(t,s)}}keyListener(){this.element.addEventListener("submit",(e=>{e.preventDefault(),this.keyHandler()}))}keyHandler(){const e=document.querySelector(".chat__field"),t={},n=s.getDate();t.name=`${document.querySelector(".you").dataset.myName}, ${n.hour}:${n.minute} ${n.day}.${n.month}.${n.year}`,t.text=e.value,document.activeElement===e&&(this.request.sendWS(t),e.value="")}static getDate(){const e=new Date,t=s.format(e.getMonth()+1),n=s.format(e.getDate());let a=s.format(e.getHours());return 24===a&&(a=0),{month:t,day:n,hour:a,minute:s.format(e.getMinutes()),year:+e.getFullYear().toString().slice(2)}}static format(e){return e<10&&(e=`0${e}`),e}}new s(document)})();